<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../styles/nav-bar.css">
    <link rel="stylesheet" href="../styles/side-bar.css">
    <link rel="stylesheet" href="../styles/main-content.css">
    <link rel="stylesheet" href="../styles/searchmenu.css">
    <link rel="stylesheet" href="../styles/listingsPage.css">
    <link rel='stylesheet'
      href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css'>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
    <title>ProfilProfesor</title>
    <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body, html {
      position: relative;
      height: 100%;
      font-family: Lato, normal;
    }
    .chart-container {
      width: 60%;
      height: 400px;
      margin: 20px auto;
    }
  </style>
  </head>
  <body>
    <!-- This is the NavBar -->
    <nav class="navbar">
      <div class="navleft">
        <div class="logo"><a href="/loggedTeacher">In&lt;form&gt;atiX</a> </div>
      </div>
      <div class="navright">
        <ul>
          <li><a href="/loggedTeacher">Home</a></li>
          <li><a href="/" onclick="logout()">LogOut</a></li>
          <li><a href="mailto:assistance@informatix.com">Contact</a></li>
        </ul>
      </div>
    </nav>

    <!-- This is the SideBar -->
    <nav class="sidebar">
      <div class="top">
        <div class="menu">
          <i class='bx bx-code'></i>
          <span>Menu</span>
        </div>
        <i class='bx bx-menu' id="btn"></i>
      </div>
      <ul>
        <li><a href="/loggedTeacher"><i class='bx bxs-home'></i><span
              class="navitem">Home</span></a></li>
        <li><a href="/ProfilProfesor"><i
              class='bx bxs-user-circle'></i><span
              class="navitem">Profile</span></a></li>
        <li><a href="/VisGroupsTeacher"><i class='bx bxs-group'></i><span
              class="navitem">Groups</span></a></li>
        <li><a href="/VisHWTeacher"><i class='bx bxs-book-alt'></i><span
              class="navitem">Homeworks</span></a></li>
        <li><a href="/submitedProblems"><i
              class='bx bxs-book-content'></i><span class="navitem">Proposed
              Problems</span></a></li>
        <li><a href="/createProblem"><i class='bx bxs-edit'></i><span
              class="navitem">New Problem</span></a></li>
        <li><a href="mailto:assistance@informatix.com"><i
              class='bx bxs-contact'></i><span
              class="navitem">Contact</span></a></li>
        <li><a href="/" onclick="logout()"><i class='bx bx-log-out'></i><span
              class="navitem">LogOut</span></a></li>
      </ul>
    </nav>
    <div class="maincontent" style="justify-content: center;">
      <div class="ProfilePage">
        <h1>Profile</h1>
        <div class="profileContent">
          <div class="NumePrenume">
            <header>Username</header>
            <input type="text" id="name" value="NumePrenume" disabled />
          </div>
          <div class="Mail">
            <header>Mail</header>
            <input type="email" id="email" value="profesor@gmail.com" disabled />
          </div>
          <div class="Password">
            <header>Password</header>
            <input type="password" id="password" value="" />
          </div>
          <div class="profileButtons">
            <button id="editProfile">Edit</button>
            <button id="deleteProfile">Delete</button>
          </div>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="reportChart" width="400" height="400"></canvas>
      </div>
    </div>
    <script src="../scripts/script.js"></script>
    <script src="../scripts/logout.js"></script>
    <script src="../scripts/checkProfesor.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const userType = localStorage.getItem('userType');
        const userId = localStorage.getItem('id');
  
        if (userType && userId) {
          fetch('http://localhost:3000/getAccountDetails', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: parseInt(userId), type: userType })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              document.getElementById('name').value = data.username;
              document.getElementById('email').value = data.email;
            } else {
              alert('Failed to fetch account details');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error fetching account details');
          });

          // Fetch report data and draw the chart after fetching user details
          fetch('http://localhost:3000/reports/user', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ UserID: parseInt(userId), userType })
          })
          .then(response => response.json())
          .then(data => {
            console.log('Report data:', data);
            drawChart(data);
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error fetching report data');
          });
        }
  
        document.getElementById('editProfile').addEventListener('click', () => {
          const password = document.getElementById('password').value;
  
          if (password) {
            fetch('http://localhost:3000/updateAccountDetails', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ id: parseInt(userId), type: userType, password })
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                alert('Password updated successfully');
                document.getElementById('password').value = '';
              } else {
                alert('Failed to update password');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('Error updating password');
            });
          } else {
            alert('Please enter a new password');
          }
        });
  
        document.getElementById('deleteProfile').addEventListener('click', () => {
          if (confirm('Are you sure you want to delete your account?')) {
            fetch(`http://localhost:3000/deleteAccount`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ id: parseInt(userId), type: userType })
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                alert('Account deleted successfully');
                window.location.href = '/';
              } else {
                alert('Failed to delete account');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('Error deleting account');
            });
          }
        });

        // Event listener to show password on focus
        document.getElementById('password').addEventListener('focus', function() {
          this.type = 'text';
        });
  
        // Event listener to hide password on blur
        document.getElementById('password').addEventListener('blur', function() {
          this.type = 'password';
        });
      });

      // Function to draw the pie chart
      function drawChart(data) {
        const canvas = document.getElementById('reportChart');
        const ctx = canvas.getContext('2d');

        // Clear the canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Define the data
        const total = data.ProblemeDeCorectat;
        const solved = data.ProblemeCorectate;
        const unsolved = total - solved;

        // Calculate the angles
        const solvedAngle = (solved / total) * 2 * Math.PI;
        const unsolvedAngle = (unsolved / total) * 2 * Math.PI;

        // Draw the solved slice
        ctx.fillStyle = '#4CAF50';
        ctx.beginPath();
        ctx.moveTo(canvas.width / 2, canvas.height / 2);
        ctx.arc(canvas.width / 2, canvas.height / 2, canvas.height / 2, 0, solvedAngle);
        ctx.closePath();
        ctx.fill();

        // Draw the unsolved slice
        ctx.fillStyle = '#F44336';
        ctx.beginPath();
        ctx.moveTo(canvas.width / 2, canvas.height / 2);
        ctx.arc(canvas.width / 2, canvas.height / 2, canvas.height / 2, solvedAngle, solvedAngle + unsolvedAngle);
        ctx.closePath();
        ctx.fill();

        // Add the legend
        ctx.fillStyle = '#000';
        ctx.textAlign = 'left';
        ctx.fillText(`Total: ${total}`, 10, 20);
        ctx.fillText(`Solved: ${solved}`, 10, 40);
        ctx.fillText(`Unsolved: ${unsolved}`, 10, 60);
      }
    </script>
  </body>
</html>
