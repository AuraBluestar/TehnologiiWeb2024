<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../styles/nav-bar.css">
  <link rel="stylesheet" href="../styles/side-bar.css">
  <link rel="stylesheet" href="../styles/main-content.css">
  <link rel="stylesheet" href="../styles/searchmenu.css">
  <link rel="stylesheet" href="../styles/listingsPage.css">
  <link rel='stylesheet' href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css'>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
  <title>Homeworks</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body, html {
      position: relative;
      height: 100%;
      font-family: Lato, normal;
    }
  </style>
</head>
<body>
  <!-- This is the NavBar -->
  <nav class="navbar">
    <div class="navleft">
      <div class="logo"><a href="/loggedStudent">In&lt;form&gt;atiX</a></div>
    </div>
    <div class="navright">
      <ul>
        <li><a href="/loggedStudent">Home</a></li>
        <li><a href="/" onclick="logout()">LogOut</a></li>
        <li><a href="mailto:assistance@informatix.com">Contact</a></li>
      </ul>
    </div>
  </nav>

  <!-- This is the SideBar -->
  <nav class="sidebar">
    <div class="top">
      <div class="menu">
        <i class='bx bx-code'></i>
        <span>Menu</span>
      </div>
      <i class='bx bx-menu' id="btn"></i>
    </div>
    <ul>
      <li><a href="/loggedStudent"><i class='bx bxs-home'></i><span class="navitem">Home</span></a></li>
      <li><a href="/ProfilStudent"><i class='bx bxs-user-circle'></i><span class="navitem">Profile</span></a></li>
      <li><a href="/VisGroupsStudent"><i class='bx bxs-group'></i><span class="navitem">Groups</span></a></li>
      <li><a href="/VisHWStudent"><i class='bx bxs-book-alt'></i><span class="navitem">Homeworks</span></a></li>
      <li><a href="mailto:assistance@informatix.com"><i class='bx bxs-contact'></i><span class="navitem">Contact</span></a></li>
      <li><a href="/" onclick="logout()"><i class='bx bx-log-out'></i><span class="navitem">LogOut</span></a></li>
    </ul>
  </nav>

  <div class="maincontent">
    <div class="searchmenu">
      <div class="searchbox">
        <header>Teacher's Name</header>
        <div class="searchfield">
          <form id="search">
            <div class="seachBar">
              <input id="teacherNameInput" class="search-input" type="search" placeholder="Search">
              <i class='bx bx-search-alt-2'></i>
            </div>
          </form>
        </div>
      </div>
      <div class="filterbox">
        <form id="filtermenu">
          <header>Group</header>
          <div class="dropdown">
            <div class="selectbtn" id="selectBtnGroup">
              <span class="sBtn-text">Select your option</span>
              <i class="bx bx-chevron-down"></i>
            </div>
            <ul class="dmenu" id="groupDropdown">
              <li class="option"><span class="option-text">None</span></li>
              <li class="option"><span class="option-text">A1-Advanced Programming</span></li>
              <li class="option"><span class="option-text">B1-SGBD</span></li>
              <li class="option"><span class="option-text">A1-Software Engineering</span></li>
              <li class="option"><span class="option-text">A4-Web Technologies</span></li>
            </ul>
          </div>
          <button type="submit" class="filter">Filter</button>
        </form>
      </div>
    </div>
    <div class="HomeworksPage"></div>
  </div>
  <script src="../scripts/script.js"></script>
  <script src="../scripts/logout.js"></script>
  <script src="../scripts/checkStudent.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const studentId = localStorage.getItem('id');
      let uniqueClasses = new Set();
      let homeworksData = [];

      function loadHomeworks(homeworks) {
        const homeworksContainer = document.querySelector('.HomeworksPage');
        homeworksContainer.innerHTML = '';

        homeworks.forEach(homework => {
          const homeworkDiv = document.createElement('div');
          homeworkDiv.classList.add('homework');

          const contentDiv = document.createElement('div');
          contentDiv.classList.add('homework-content');
          
          const title = document.createElement('h2');
          title.classList.add('homework-title');
          title.textContent = `ID: ${homework.temaID}`;
          
          const homeworkId = document.createElement('p');
          homeworkId.classList.add('homework-id');
          homeworkId.innerHTML = `<strong>Professor:</strong> Loading...`;
          
          const group = document.createElement('p');
          group.classList.add('homework-group');
          group.innerHTML = `<strong>Class:</strong> Loading...`;
          
          const problemCount = document.createElement('p');
          problemCount.classList.add('homework-problem-count');
          problemCount.innerHTML = `<strong>Problems:${homework.nrProbleme}</strong> `;

          contentDiv.appendChild(title);
          contentDiv.appendChild(homeworkId);
          contentDiv.appendChild(group);
          contentDiv.appendChild(problemCount);
          homeworkDiv.appendChild(contentDiv);
    
          homeworksContainer.appendChild(homeworkDiv);

          fetch(`http://localhost:3000/group/${homework.clasaID}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          })
          .then(response => response.json())
          .then(classData => {
            const className = classData['Grupa-Materie'];
            uniqueClasses.add(className);
            group.innerHTML = `<strong>Class:</strong> ${className}`;
            homework.Grupa = className; // Assign the class name to homework object
            
            homeworkDiv.addEventListener('click', () => {
              localStorage.setItem('homeworkId', homework.temaID);
              localStorage.setItem('className', className);
              window.location.href = '/uniqueHWStudent';
            });

            return fetch(`http://localhost:3000/Teacher/${classData.ProfesorID}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            })
            .then(response => response.json())
            .then(professorData => {
              const professorName = professorData.nume;
              homeworkId.innerHTML = `<strong>Professor:</strong> ${professorName}`;
              homework.Profesor = professorName; // Assign the professor name to homework object

              const classDropdown = document.querySelector('#groupDropdown');
              classDropdown.innerHTML = '<li class="option"><span class="option-text">All</span></li>';
              uniqueClasses.forEach(classItem => {
                const classOption = document.createElement('li');
                classOption.classList.add('option');
                classOption.innerHTML = `<span class="option-text">${classItem}</span>`;
                classDropdown.appendChild(classOption);
              });

              const selectBtn = document.querySelector('#selectBtnGroup');
              const sBtnText = document.querySelector('.sBtn-text');
              classDropdown.addEventListener('click', (e) => {
                const option = e.target.closest('.option');
                if (option) {
                  sBtnText.textContent = option.textContent;
                  selectBtn.dataset.value = option.textContent;
                }
              });
            });
          })
          .catch(error => {
            console.error('Error fetching details:', error);
          });
        });
      }

      fetch("http://localhost:3000/homeworks/student", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ elevID: parseInt(studentId) })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          homeworksData = data.data;
          loadHomeworks(homeworksData);
        } else {
          console.error("Failed to fetch homeworks data");
        }
      })
      .catch(error => {
        console.error("Error:", error);
      });

      document.getElementById('filtermenu').addEventListener('submit', function(event) {
        event.preventDefault();
        
        const selectedGroup = document.getElementById('selectBtnGroup').dataset.value || 'All';
        const teacherName = document.getElementById('teacherNameInput').value.trim().toLowerCase();

        console.log('Selected Group:', selectedGroup);
        console.log('Teacher Name:', teacherName);

        let filteredHomeworks = homeworksData;

        if (selectedGroup !== 'All') {
          filteredHomeworks = filteredHomeworks.filter(hw => hw.Grupa === selectedGroup);
        }
        if (teacherName) {
          filteredHomeworks = filteredHomeworks.filter(hw => hw.Profesor.toLowerCase().includes(teacherName));
        }
        loadHomeworks(filteredHomeworks);
      });

      function toggleDropdown(event) {
        const dropdown = event.currentTarget.nextElementSibling;
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
      }

      document.getElementById('selectBtnGroup').addEventListener('click', toggleDropdown);
    });
  </script>
</body>
</html>
